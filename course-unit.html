<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="https://i.imgur.com/WPy5YDY.png">
    <title>Course Unit | Literary Speaking</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .lesson-layout { display: flex; gap: 40px; }
        .lesson-sidebar { width: 220px; flex-shrink: 0; }
        .lesson-sidebar-nav { list-style: none; padding: 0; margin: 0; position: sticky; top: 120px; }
        .lesson-sidebar-nav .back-link { display: block; padding: 10px 0; font-weight: 700; color: var(--color-primary); text-decoration: none; margin-bottom: 15px; text-align: left; }
        .lesson-sidebar-nav a.lesson-nav-link { display: block; padding: 10px 15px; text-decoration: none; color: #333; font-weight: 700; border-left: 3px solid transparent; text-align: left; }
        .lesson-sidebar-nav a.lesson-nav-link.active { border-left-color: #333; }
        .lesson-main-content { flex-grow: 1; }
        .breadcrumbs { padding: 15px 0; font-size: 0.9rem; color: var(--color-text-muted); }
        .breadcrumbs a { color: var(--color-purple-dark); text-decoration: none; }
        .breadcrumbs a:hover { text-decoration: underline; }
        .breadcrumbs span { margin: 0 8px; }
        .unit-header { text-align: left; border-bottom: 1px solid #eee; padding-bottom: 20px; margin-bottom: 30px; }
        .unit-title { font-size: 2.8rem; font-weight: 900; margin: 0; line-height: 1.2; }
        .unit-body { text-align: left; line-height: 2; font-size: 1.1rem; }
        .unit-body p { margin: 0 0 1.5em; }
        .unit-body figure { margin: 30px 0; }
        .unit-body img { width: 100%; max-width: 800px; border-radius: 16px; margin: 0 auto; display: block; }
        .unit-body figcaption { font-size: 0.9rem; color: var(--color-text-light); text-align: center; margin-top: 10px; font-style: italic; }
        .video-container { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; max-width: 100%; background: #000; border-radius: 16px; margin: 30px 0; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .back-link { display: inline-block; margin-bottom: 20px; font-weight: 700; color: var(--color-purple-dark); text-decoration: none; }
        .back-link:hover { text-decoration: underline; }
        @media (max-width:768px){ .unit-title { font-size: 2rem; } .lesson-layout { flex-direction: column; } .lesson-sidebar { width: 100%; } .lesson-sidebar-nav { position: static; } }
    </style>
</head>
<body data-current-page="lessons">
    <header class="site-header" id="header"></header>

    <main>
        <section class="section">
            <div class="container page-specific-content">
                <div class="lesson-layout">
                    <aside class="lesson-sidebar">
                        <ul id="lesson-sidebar-nav" class="lesson-sidebar-nav">
                        </ul>
                    </aside>
                    <div id="unit-content-wrapper" class="lesson-main-content">
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer class="site-footer"></footer>

    <script src="router.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD0qVihpuLI0cF0PZ32o8tFBLfTgjlqB6A",
            authDomain: "literary-speaking.firebaseapp.com",
            projectId: "literary-speaking",
            storageBucket: "literary-speaking.appspot.com",
            messagingSenderId: "699059463612",
            appId: "1:699059463612:web:ecb2e784d627c6b93937b9",
            measurementId: "G-0L1V3XXGGR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const getYouTubeID = (url) => {
            const regex = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regex);
            return (match && match[2].length === 11) ? match[2] : url;
        };

        const renderUnit = (subject, course, module, unit, lang) => {
            const contentWrapper = document.getElementById('unit-content-wrapper');
            const sidebarNav = document.getElementById('lesson-sidebar-nav');
            if (!contentWrapper || !sidebarNav || !unit) return;

            document.title = `${unit[`title_${lang}`]} | Literary Speaking`;

            sidebarNav.innerHTML = `
                <li><a class="back-link" href="lessons.html"><span class="lang-switch" data-en="← Back to all lessons" data-es="← Volver a todas las lecciones"></span></a></li>
                <li><a href="lesson-single.html?id=${subject.id}" class="lesson-nav-link lang-switch" data-en="Home" data-es="Inicio"></a></li>
                <li><a href="lesson-single.html?id=${subject.id}" class="lesson-nav-link active lang-switch" data-en="Modules" data-es="Módulos"></a></li>
                <li><a href="lesson-single.html?id=${subject.id}" class="lesson-nav-link lang-switch" data-en="Discussions" data-es="Discusiones"></a></li>
                <li><a href="lesson-single.html?id=${subject.id}" class="lesson-nav-link lang-switch" data-en="More Resources" data-es="Más Recursos"></a></li>
            `;

            let contentBlocksHTML = '';
            (unit.contentBlocks || []).forEach(block => {
                const caption = block[`caption_${lang}`] || '';
                switch (block.type) {
                    case 'text':
                        contentBlocksHTML += block[`content_${lang}`] || '';
                        break;
                    case 'image':
                        contentBlocksHTML += `<figure><img src="${block.url}" alt="${caption}"><figcaption>${caption}</figcaption></figure>`;
                        break;
                    case 'video':
                        const videoId = getYouTubeID(block.videoId || '');
                        contentBlocksHTML += `
                            <figure>
                                <div class="video-container">
                                    <iframe src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                                </div>
                                <figcaption>${caption}</figcaption>
                            </figure>
                        `;
                        break;
                }
            });

            contentWrapper.innerHTML = `
                <div class="breadcrumbs">
                    <a href="lesson-single.html?id=${subject.id}">${subject[`title_${lang}`]}</a>
                    <span>></span>
                    <span>${course[`title_${lang}`]}</span>
                    <span>></span>
                    <span>${module[`title_${lang}`]}</span>
                </div>
                <div class="unit-header">
                    <h1 class="unit-title">${unit[`title_${lang}`]}</h1>
                </div>
                <div class="unit-body">${contentBlocksHTML}</div>
            `;
            
            siteRouter.applyLanguage(lang);
        };

        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const subjectId = urlParams.get('subjectId');
            const courseIndex = parseInt(urlParams.get('courseIndex'), 10);
            const moduleIndex = parseInt(urlParams.get('moduleIndex'), 10);
            const unitIndex = parseInt(urlParams.get('unitIndex'), 10);

            if (!subjectId || isNaN(courseIndex) || isNaN(moduleIndex) || isNaN(unitIndex)) {
                return siteRouter.navigateTo('lessons');
            }

            const docRef = doc(db, "lessons", subjectId);
            const docSnap = await getDoc(docRef);

            if (!docSnap.exists()) {
                return siteRouter.navigateTo('lessons');
            }

            const subject = { id: docSnap.id, ...docSnap.data() };
            const course = subject.courses?.[courseIndex];
            const module = course?.modules?.[moduleIndex];
            const unit = module?.units?.[unitIndex];

            if (!unit) {
                console.error("Could not find the specified unit with the provided indices.");
                return siteRouter.navigateTo('lessons');
            }

            const initialLang = localStorage.getItem('language') || 'en';
            renderUnit(subject, course, module, unit, initialLang);

            document.addEventListener('languageChanged', (e) => {
                renderUnit(subject, course, module, unit, e.detail.lang);
            });
        });
    </script>
</body>
</html>
